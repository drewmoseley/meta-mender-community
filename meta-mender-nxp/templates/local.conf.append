# Appended fragment from meta-mender-community/meta-mender-nxp/templates

# Supported machines are:
#    - imx7s-warp
#    - imx7d-pico
#    - nitrogen6x
#    - pico-imx7
#    - pico-imx6ul
#
MACHINE ?= "imx7s-warp"

DISTRO ?= "fslc-framebuffer"

IMAGE_INSTALL_append = " kernel-image kernel-devicetree"

MENDER_FEATURES_DISABLE_append = " mender-grub mender-image-uefi"

IMAGE_BOOT_FILES_imx7s-warp = "boot.scr"
MENDER_UBOOT_STORAGE_INTERFACE_imx7s-warp = "mmc"
MENDER_UBOOT_STORAGE_DEVICE_imx7s-warp = "0"
MENDER_STORAGE_DEVICE_imx7s-warp = "/dev/mmcblk1"
MENDER_UBOOT_ENV_STORAGE_DEVICE_OFFSET_1_imx7s-warp = "0x80000"
MENDER_UBOOT_ENV_STORAGE_DEVICE_OFFSET_2_imx7s-warp = "0xA0000"

MENDER_UBOOT_STORAGE_INTERFACE_imx7d-pico = "mmc"
MENDER_UBOOT_STORAGE_DEVICE_imx7d-pico = "0"
MENDER_STORAGE_DEVICE_imx7d-pico = "/dev/mmcblk1"
MENDER_UBOOT_ENV_STORAGE_DEVICE_OFFSET_1_imx7d-pico = "0x80000"
MENDER_UBOOT_ENV_STORAGE_DEVICE_OFFSET_2_imx7d-pico = "0xA0000"

# We install update.scr and u-boot in boot part because we need
# to flash U-boot in first boot. The bootloader is stored on a
# external EEPROM.
#
# To program U-boot we need to run:
#
#    run upgradeu
#
# and to make sure that correct U-boot env is used:
#
#    env default -a
#    saveenv
#
IMAGE_BOOT_FILES_nitrogen6x = "\
    boot.scr-nitrogen6x;boot.scr \
    upgrade.scr-nitrogen6x;upgrade.scr \
    u-boot-nitrogen6x.imx;u-boot.nitrogen6q \
"

# Specific Configuration for Mender
MENDER_FEATURES_ENABLE_append_pico_imx7 = " mender-uboot mender-image-sd"
MENDER_FEATURES_DISABLE_append_pico_imx7 = " mender-grub mender-image-uefi"

# Specific Kernel devicetree and U-Boot Configuration for Pico-Pi i.MX7D
MENDER_STORAGE_DEVICE_pico-imx7 = "/dev/mmcblk2"
MENDER_UBOOT_STORAGE_INTERFACE_pico-imx7 = "mmc"
MENDER_UBOOT_STORAGE_DEVICE_pico-imx7 = "0"
MENDER_UBOOT_ENV_STORAGE_DEVICE_OFFSET_1_pico-imx7 = "0xC0000"
MENDER_UBOOT_ENV_STORAGE_DEVICE_OFFSET_2_pico-imx7 = "0xE0000"
MENDER_STORAGE_TOTAL_SIZE_MB_pico-imx7 = "2048"
PREFERRED_PROVIDER_u-boot-fw-utils_pico-imx7 ?= "u-boot-edm-fw-utils"
PREFERRED_RPROVIDER_u-boot-fw-utils_pico-imx7 ?= "u-boot-edm-fw-utils"
IMAGE_FSTYPES_remove_pico-imx7="tar.bz2 ext4 sdcard.bz2 mender.bmap"
IMAGE_BOOT_FILES_pico-imx7="u-boot.img uEnv.txt"
IMAGE_BOOTLOADER_FILE_pico-imx7="SPL"
MENDER_UBOOT_PRE_SETUP_COMMANDS_pick-imx7 = "run loadbootenv; run importbootenv; setenv kernel_addr_r \${loadaddr}; setenv bootargs console=\${console},\${baudrate}; run setfdt; setenv mender_dtb_name \${fdtfile}; "

# Specific Kernel devicetree and U-Boot Configuration for Pico-Pi i.MX6ULL
MENDER_STORAGE_DEVICE_pico-imx6ul = "/dev/mmcblk0"
MENDER_UBOOT_STORAGE_INTERFACE_pico-imx6ul = "mmc"
MENDER_UBOOT_STORAGE_DEVICE_pico-imx6ul = "0"
MENDER_UBOOT_ENV_STORAGE_DEVICE_OFFSET_1_pico-imx6ul = "0xC0000"
MENDER_UBOOT_ENV_STORAGE_DEVICE_OFFSET_2_pico-imx6ul = "0xE0000"

MENDER_STORAGE_TOTAL_SIZE_MB_pico_imx6ul = "2048"
PREFERRED_PROVIDER_u-boot-fw-utils_pico_imx6ul ?= "u-boot-edm-fw-utils"
PREFERRED_RPROVIDER_u-boot-fw-utils_pico_imx6ul ?= "u-boot-edm-fw-utils"
IMAGE_FSTYPES_remove_pico_imx6ul="tar.bz2 ext4 sdcard.bz2 mender.bmap"
IMAGE_BOOT_FILES_pico_imx6ul="u-boot.img uEnv.txt"
IMAGE_BOOTLOADER_FILE_pico_imx6ul="SPL"
MENDER_UBOOT_PRE_SETUP_COMMANDS_pico_imx6ul = "run loadbootenv; run importbootenv; setenv kernel_addr_r \${loadaddr}; setenv bootargs console=\${console},\${baudrate}; run setfdt; setenv mender_dtb_name \${fdtfile}; "
